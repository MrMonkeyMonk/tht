% zq, partial
;TODO can't insert in the middle

# Include outbound traffic (int->ext)
local_orig == true and local_resp == false

# Include outbound traffic by cidr (int->ext)
((id.orig_h in 192.168.0.0/16 or id.orig_h in 172.16.0.0/12 or id.orig_h in 10.0.0.0/8) and not (id.resp_h in 192.168.0.0/16 or id.resp_h in 172.16.0.0/12 or id.resp_h in 10.0.0.0/8))

# Include inbound traffic (ext->int)
local_orig == false and local_resp == true

# Include inbound traffic by cidr (ext->int)
(not (id.orig_h in 192.168.0.0/16 or id.orig_h in 172.16.0.0/12 or id.orig_h in 10.0.0.0/8) and (id.resp_h in 192.168.0.0/16 or id.resp_h in 172.16.0.0/12 or id.resp_h in 10.0.0.0/8))

# Exclude local traffic (int<->int)
not (local_orig == true and local_resp == true)

# Exclude local traffic by cidr (int<->int)
not ((id.orig_h in 192.168.0.0/16 or id.orig_h in 172.16.0.0/12 or id.orig_h in 10.0.0.0/8) and (id.resp_h in 192.168.0.0/16 or id.resp_h in 172.16.0.0/12 or id.resp_h in 10.0.0.0/8))

# Exclude remote traffic (ext<->ext)
not (local_orig == false and local_resp == false)

# Exclude remote traffic by cidr (ext<->ext)
not (not (id.orig_h in 192.168.0.0/16 or id.orig_h in 172.16.0.0/12 or id.orig_h in 10.0.0.0/8) and not (id.resp_h in 192.168.0.0/16 or id.resp_h in 172.16.0.0/12 or id.resp_h in 10.0.0.0/8))

# Calculate PCR
sum_orig=sum(orig_bytes:int64),sum_resp=sum(resp_bytes:int64) by src=id.orig_h,dst=id.resp_h | put pcr=(sum_orig-sum_resp)/(sum_orig+sum_resp+0.001)

